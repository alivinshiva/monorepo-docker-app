# here we will write yml to deploy our backend service to production using github actions.
# steps
# build the docker image
# push the docker image to docker hub
# deploy the docker image to production server using ssh
name: CD WS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy monorepo-ws to ec2
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Build and push to docker hub
        uses: docker/build-push-action@v3
        with:
          context: .
          file: ./docker/dockerfile.ws
          build-args: |
            DATABASE_URL=${{ secrets.DATABASE_URL }}
          push: true
          tags: alivinshiva/monorepo-ws:${{ github.sha }}

          #  deploy to vm /ec2 instance
      - name: Deploy to vm
        run: |
          echo "${{ secrets.SSH_PVT_KEY }}" > ~/ssh_key
          chmod 600 ~/ssh_key

          mkdir -p ~/.ssh
          echo "${{ secrets.KNOWN_HOST }}" > ~/.ssh/known_hosts

          ssh -i ~/ssh_key -o StrictHostKeyChecking=no ubuntu@3.110.210.2 << 'EOF'
            docker pull alivinshiva/monorepo-ws:${{ github.sha }}
            docker stop monorepo-ws || true
            docker rm monorepo-ws || true
            docker run -d -p 8081:8081 --name monorepo-ws alivinshiva/monorepo-ws:${{ github.sha }}




# more fast and optimize d way to deploy using ssh action
# name: CD WS

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     name: Deploy monorepo-ws to EC2

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Log in to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_HUB_USERNAME }}
#           password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

#       - name: Build and push to Docker Hub
#         uses: docker/build-push-action@v6
#         with:
#           context: .
#           file: ./docker/dockerfile.ws
#           build-args: |
#             DATABASE_URL=${{ secrets.DATABASE_URL }}
#           push: true
#           tags: |
#             alivinshiva/monorepo-ws:latest
#             alivinshiva/monorepo-ws:${{ github.sha }}
#           cache-from: type=gha
#           cache-to: type=gha,mode=max

#       - name: Deploy to EC2
#         run: |
#           echo "${{ secrets.SSH_PVT_KEY }}" > ~/ssh_key
#           chmod 600 ~/ssh_key

#           mkdir -p ~/.ssh
#           echo "${{ secrets.KNOWN_HOST }}" > ~/.ssh/known_hosts

#           ssh -i ~/ssh_key -o StrictHostKeyChecking=no ubuntu@3.7.73.221 << 'EOF'
#             set -e

#             echo "ðŸ›‘ Stopping old WebSocket container..."
#             docker stop monorepo-ws || true
#             docker rm monorepo-ws || true

#             echo "ðŸ“¦ Pulling latest WebSocket image..."
#             docker pull alivinshiva/monorepo-ws:latest

#             echo "ðŸš€ Running new WebSocket container..."
#             docker run -d \
#               -p 8081:8081 \
#               --name monorepo-ws \
#               --restart always \
#               -e DATABASE_URL='${{ secrets.DATABASE_URL }}' \
#               alivinshiva/monorepo-ws:latest

#             echo "âœ… WebSocket service deployed successfully!"
#             docker ps | grep monorepo-ws
#           EOF
